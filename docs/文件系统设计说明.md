# 文件系统设计说明

文件系统整体遵循和主流分布式文件系统相似的设计，分为datanode和masternode两个部分。
文件系统Client提供给后端有关于文件操作的API，对于不同的文件操作，需要涉及到向masternode
发送元数据，并得到相关数据所在的datanode，然后向datanode发起RPC请求，来读取或者写入数据。

## Masternode设计说明
// TODO

## Datanode设计说明

### RPC

Datanode主要负责Chunk级别的读写操作，提供的RPC有ReadChunk，WriteChunk和DeleteChunk三种。

文件系统的Client会调用ReadChunk，WriteChunk来进行Chunk级别的读写，而在文件彻底删除不再需要从回收站恢复之后，Master会调用DeleteChunk来永久删除该Chunk文件。

### 持久化格式

Datanode以chunk文件为粒度在磁盘上进行持久化，存储文件命名为`chunk_{#chunk_id}`, 内部存储的数据为:
```
#data_1_offset: #data1
...
#data_n_offse:  #datan
#MAX_DATA_OFFSET: version_{#version_id}
```
我们认为现代操作系统的Page cache已经可以很好的对数据进行缓存操作，手动维护内存的缓存在我们对文件的存储方式并没有对比操作系统更好的认识的时候是没有必要的，所以在这里所有的文件读写操作我们都直接利用操作系统的文件接口。

### 多备份与容错

Page Cache并不能保证文件落盘的问题我们的项目使用记Log的方式来进行保证。
Datanode只需要记录Write时候的修改，即在WriteChunk时记Log，需要记录的东西包括：
- `datanode id`  -- datanode组的ID（ZK中的ID，所有对应的主从datanode都需要读取这一log记录到自己的持久化磁盘中）
- `version` -- 当前文件的version号
- `chunk id`, `offset`, `size`  -- 实际需要写入的data的chunk的id、写入起始offset、数据size
- `data(zip form)`  -- 数据的zip压缩格式
- `checksum of data`  -- data的checksum

|<-- version -->|<-- chunk id -->|<-- offset -->|<-- size -->|<-- checksum -->|<-- zip(data) -->|
|<--  64bit  -->|<--   64bit  -->|<--  64bit -->|<-- 64bit-->|<---  32bit  -->|<--           -->|

注意:

这里的datanode id会作为多个topic组来加以区分。

会在log中记录data的压缩格式数据来节省在kafka中存储的内容的大小，
同时还会记录checksum来在持久化的时候和本地磁盘中的数据进行比较，
从而快速比较得出该log是否已经做完的判断，避免解压缩

Datanode的管理采用主从结构，使用ZooKeeper的节点来记录Primary Datanode的地址，同时通过ZooKeeper创建节点的机制可以进行Leader的选举，新Primary Datanode的地址就会记录在该记录节点中。Client在发现某些RPC失效后只需要去重新询问这一记录节点，再次尝试连接，直到最后获得了正确的Datanode的地址即可。

Primary Datanode会将日志记录到Kafka中，Secondary Datanode会去Log中阅读数据来和Primary Datanode进行同步

## 与GFS的区别
1. 我们这里Chunk的粒度较小。因此如果在master维护所有的chunk地址数据会有较大的开销，同时Chunk向Server发送数据也涉及到很多数据的网络传输。所以我们这里将datanode改为了机器为粒度的备份，牺牲了一定的系统伸缩性和资源均匀利用率，但考虑到我们当前的应用场景有大量的写入操作，需要很多元数据的更新，现在的设计极大的减少了这些开销
2. GFS采用了同步数据写入，即Primary Datanode需要等到所有Secondary Datanodes的回复才返回客户端。而我们的文件系统采用异步的数据更新，虽然不能做到即时从任意副本读到最新的数据，但考虑到我们系统只有在1.第一次打开文件进行全局的读取时 2.写入或修改某一单元格，需要将新的数据转发到其他前端时，才会涉及到读操作，所以异步的写入是合理的，可以整体的提高读写性能。

